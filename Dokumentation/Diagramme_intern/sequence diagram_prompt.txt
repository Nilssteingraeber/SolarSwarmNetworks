@startuml

actor Robot as robot
actor "Data Sink" as datasink
database "Database" as db

[-> robot
activate robot

loop timer
  robot -> datasink : publish on topic
  activate datasink

  datasink -> datasink : call check_nid
  activate datasink
  datasink --> datasink
  deactivate datasink

  datasink -> datasink : match topic and update dict
  activate datasink
  datasink --> datasink
  deactivate datasink

  alt received on topic activity
    datasink -> db : update state on table Robot
    activate db
    db --> datasink
    deactivate db
  end
  datasink --> robot
  deactivate datasink
end

[<-- robot
deactivate robot

[-> datasink
activate datasink
loop timer
  datasink -> datasink : call forward_batch
  activate datasink

  datasink -> datasink : call register_new_nodes
  activate datasink
  alt unregistered nodes present (nid not in nid_map)
    loop for each unregistered node
      datasink -> db : insert nid into table Robot
      activate db
      db --> datasink
      deactivate db
    end

    datasink -> db : query nids and robotIds
    activate db
    db --> datasink
    deactivate db
  end
  datasink --> datasink
  deactivate datasink

  loop for each node
    datasink -> db : insert into Status
    activate db
    db --> datasink
    deactivate db
    
    datasink -> db : insert into Neighbor
    activate db
    db --> datasink
    deactivate db
  end
  
  datasink --> datasink
  deactivate datasink
end
[<-- datasink
deactivate datasink

@enduml