# docker stack delpoy does not build images - 'docker-compose.yaml' needs to be built first

# this file is meant to be merged with 'docker-compose.yaml' during deploy
# merging happens when multiple files are added with the `-c` option on deploy
# related: https://docs.docker.com/compose/how-tos/multiple-compose-files/merge/

# deploy with `sudo docker stack delpoy -c docker-compose.yaml -c docker-stack.yaml SolarSwarm`
# monitor service replication with `sudo docker service ls`
# see locally running services with `sudo docker ps`
# see nodes in swarm with `sudo docker `
# remove with `sudo docker stack rm SolarSwarm`

services:
  base_robot:
    # base_robot should run on all robots
    # to excluse nodes from this, change those nodes' availability to drain
    # or introduce a new required label for this service and add a matching constraint
    networks:
      - external
    deploy:
      mode: global
  
  data_sink:
    networks:
      - internal
      - external
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.has_data_sink==true # should only be given once (same host which runs frontend, backend and db)
  
  db:
    networks:
      - internal
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.has_data_sink==true # should only be given once (same host which runs frontend, backend and db)

  adminer:
    networks:
      - internal
      - external
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.has_data_sink==true # should only be given once (same host which runs frontend, backend and db)

  backend:
    networks:
      - internal
      - external
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.has_data_sink == true # should only be given once (same host which runs frontend, backend and db)

  fibonacci_example:
    networks:
      - external
    deploy:
      mode: replicated
      replicas: 2
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.labels.ram_ge8 == true
    
  get_service_server_mac_example:
    deploy:
      mode: global

  int_avg_example:
    networks:
      - external
    deploy:
      mode: replicated
      replicas: 2
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.labels.ram_ge8 == true

  int_rng_example:
    networks:
      - external
    deploy:
      mode: replicated
      replicas: 2
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.labels.ram_ge8 == true

  str_to_lower_upper_example:
    networks:
      - external
    deploy:
      mode: replicated
      replicas: 2
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.labels.ram_ge8 == true

  ### 3D - Meshes on Map ###
  # Deutschland – Zero – Version 2.0
  # https://www.govdata.de/dl-de/zero-2-0
  three_d_server:
    networks:
      - external
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.has_3d_map_data == true

  ### Digital Elevation Model ###
  # © Bundesamt für Kartographie und Geodäsie (BKG), Datenlizenz Deutschland – Namensnennung – Version 2.0
  terrain_server:
    networks:
      - external
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.has_2d_map_data == true

  ### OpenStreetMap-Data Server ###
  # TODO OSM-License
  tileserver:
    networks:
      - external
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.has_2d_map_data == true

  ### Vue ###
  frontend:
    networks:
      - external
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.labels.has_web == true

networks:
  internal:
    driver: overlay
    attachable: true
  external:
    driver: overlay